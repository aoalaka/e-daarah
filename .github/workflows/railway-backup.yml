name: Railway MySQL Backup

on:
  schedule:
    # 2:30 AM NZST = 14:30 UTC (NZDT = 13:30 UTC, but 14:30 covers standard time)
    - cron: '30 14 * * *'
  workflow_dispatch:

env:
  DB_NAME: ${{ secrets.DB_NAME }}
  RESTORE_DB: railway_restore_test
  BACKUP_DIR: /tmp/mysql_backups
  RCLONE_REMOTE: "gdrive:backups/mysql/railway"

jobs:
  backup:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30

    steps:
      - name: Install MySQL client and rclone
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq mysql-client rclone msmtp

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" | base64 -d > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf

      - name: Configure msmtp for email alerts
        run: |
          cat > ~/.msmtprc <<'MSMTP'
          defaults
          auth           on
          tls            on
          tls_starttls   on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt
          logfile        /tmp/msmtp.log

          account        gmail
          host           smtp.gmail.com
          port           587
          from           $EMAIL_USERNAME
          user           $EMAIL_USERNAME
          password       $EMAIL_PASSWORD

          account default : gmail
          MSMTP
          # Substitute env vars (secrets can't go in heredoc directly)
          sed -i "s|\$EMAIL_USERNAME|${{ secrets.EMAIL_USERNAME }}|g" ~/.msmtprc
          sed -i "s|\$EMAIL_PASSWORD|${{ secrets.EMAIL_PASSWORD }}|g" ~/.msmtprc
          chmod 600 ~/.msmtprc

      - name: Dump production database
        run: |
          set -euo pipefail
          mkdir -p "$BACKUP_DIR"
          DATE=$(date -u +"%Y-%m-%d_%H-%M")
          FILENAME="${DB_NAME}_${DATE}.sql.gz"
          echo "FILENAME=$FILENAME" >> "$GITHUB_ENV"
          echo "DATE=$DATE" >> "$GITHUB_ENV"

          mysqldump \
            --host="${{ secrets.DB_HOST }}" \
            --port="${{ secrets.DB_PORT }}" \
            --user="${{ secrets.DB_USER }}" \
            --password="${{ secrets.DB_PASSWORD }}" \
            --single-transaction \
            --quick \
            --routines \
            --events \
            --set-gtid-purged=OFF \
            "$DB_NAME" | gzip > "$BACKUP_DIR/$FILENAME"

          SIZE=$(du -h "$BACKUP_DIR/$FILENAME" | cut -f1)
          echo "Backup size: $SIZE"
          echo "BACKUP_SIZE=$SIZE" >> "$GITHUB_ENV"

      - name: Upload to Google Drive
        run: |
          rclone copy "$BACKUP_DIR/$FILENAME" "$RCLONE_REMOTE" --checksum
          echo "Uploaded $FILENAME to $RCLONE_REMOTE"

      - name: Smart retention cleanup
        run: |
          set -euo pipefail

          # List all backups sorted by date (oldest first)
          BACKUPS=$(rclone lsf "$RCLONE_REMOTE" --files-only | sort)
          TOTAL=$(echo "$BACKUPS" | grep -c . || true)
          echo "Total backups in remote: $TOTAL"

          if [ "$TOTAL" -le 7 ]; then
            echo "7 or fewer backups — skipping retention cleanup"
            exit 0
          fi

          # Determine which files to keep
          KEEP_FILES=$(mktemp)

          # Keep last 7 daily backups
          echo "$BACKUPS" | tail -7 >> "$KEEP_FILES"

          # Keep weekly backups (oldest backup per ISO week) for last 4 weeks
          for i in $(seq 0 3); do
            WEEK_START=$(date -u -d "-$((i * 7)) days" +%Y-%m-%d 2>/dev/null || date -u -v-$((i * 7))d +%Y-%m-%d)
            WEEK_MATCH=$(echo "$BACKUPS" | grep "$(echo "$WEEK_START" | cut -c1-8)" | head -1 || true)
            if [ -n "$WEEK_MATCH" ]; then
              echo "$WEEK_MATCH" >> "$KEEP_FILES"
            fi
          done

          # Keep monthly backups (first backup per month) for last 6 months
          for i in $(seq 0 5); do
            MONTH=$(date -u -d "-$i months" +%Y-%m 2>/dev/null || date -u -v-${i}m +%Y-%m)
            MONTH_MATCH=$(echo "$BACKUPS" | grep "${DB_NAME}_${MONTH}" | head -1 || true)
            if [ -n "$MONTH_MATCH" ]; then
              echo "$MONTH_MATCH" >> "$KEEP_FILES"
            fi
          done

          # Deduplicate keep list
          KEEP_UNIQUE=$(sort -u "$KEEP_FILES")

          # Delete files not in keep list
          DELETED=0
          while IFS= read -r file; do
            if ! echo "$KEEP_UNIQUE" | grep -qF "$file"; then
              echo "Deleting old backup: $file"
              rclone deletefile "$RCLONE_REMOTE/$file"
              DELETED=$((DELETED + 1))
            fi
          done <<< "$BACKUPS"

          echo "Retention cleanup: deleted $DELETED old backups"
          rm -f "$KEEP_FILES"

      - name: Verify backup integrity
        id: verify
        run: |
          set -euo pipefail

          # 1. Check gzip integrity
          if ! gunzip -t "$BACKUP_DIR/$FILENAME"; then
            echo "::error::Backup file is corrupt (gzip test failed)"
            echo "VERIFY_STATUS=failed" >> "$GITHUB_ENV"
            echo "VERIFY_DIFF=Gzip integrity check failed" >> "$GITHUB_ENV"
            exit 0
          fi
          echo "Gzip integrity: OK"

          # 2. Extract and check SQL content
          SQL_CONTENT=$(gunzip -c "$BACKUP_DIR/$FILENAME")
          SQL_SIZE=${#SQL_CONTENT}
          echo "Uncompressed SQL size: $SQL_SIZE bytes"

          if [ "$SQL_SIZE" -lt 500 ]; then
            echo "::error::Backup too small — likely empty or failed dump"
            echo "VERIFY_STATUS=failed" >> "$GITHUB_ENV"
            echo "VERIFY_DIFF=SQL dump only $SQL_SIZE bytes" >> "$GITHUB_ENV"
            exit 0
          fi

          # 3. Check for CREATE TABLE statements
          TABLE_COUNT=$(echo "$SQL_CONTENT" | grep -c "^CREATE TABLE" || true)
          echo "Tables found in backup: $TABLE_COUNT"

          if [ "$TABLE_COUNT" -lt 1 ]; then
            echo "::error::No CREATE TABLE statements found in backup"
            echo "VERIFY_STATUS=failed" >> "$GITHUB_ENV"
            echo "VERIFY_DIFF=No tables in backup" >> "$GITHUB_ENV"
            exit 0
          fi

          # 4. List all tables in the backup
          echo "--- Tables in backup ---"
          echo "$SQL_CONTENT" | grep "^CREATE TABLE" | sed 's/CREATE TABLE `\(.*\)`.*/\1/'

          # 5. Check for INSERT statements (data exists)
          INSERT_COUNT=$(echo "$SQL_CONTENT" | grep -c "^INSERT INTO" || true)
          echo "INSERT statements: $INSERT_COUNT"

          echo "Backup verified: $TABLE_COUNT tables, $INSERT_COUNT inserts, $SQL_SIZE bytes"
          echo "VERIFY_STATUS=passed" >> "$GITHUB_ENV"

      - name: Send failure alert
        if: env.VERIFY_STATUS == 'failed'
        run: |
          cat <<EOF | msmtp "${{ secrets.EMAIL_USERNAME }}"
          Subject: [e-Daarah] Backup Verification FAILED - ${{ env.DATE }}
          From: ${{ secrets.EMAIL_USERNAME }}
          To: ${{ secrets.EMAIL_USERNAME }}

          Railway MySQL backup verification failed.

          Backup file: ${{ env.FILENAME }}
          Backup size: ${{ env.BACKUP_SIZE }}
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Row count diff:
          ${{ env.VERIFY_DIFF }}

          — e-Daarah Backup Bot
          EOF

      - name: Fail workflow if verification failed
        if: env.VERIFY_STATUS == 'failed'
        run: exit 1

      - name: Cleanup local files
        if: always()
        run: |
          rm -f "$BACKUP_DIR/$FILENAME"
          rm -f ~/.config/rclone/rclone.conf
          rm -f ~/.msmtprc
